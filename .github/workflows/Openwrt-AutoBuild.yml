#=================================================
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
# Lisence: MIT
# Author: P3TERX
# Blog: https://p3terx.com
#=================================================

name: Build OpenWrt

on:
  # åŸå§‹çš„è§¦å‘æ¡ä»¶ï¼šrepository_dispatch
  repository_dispatch:

  # ====== æ·»åŠ è¿™ä¸€æ®µï¼ä½¿å…¶å¯æ‰‹åŠ¨è§¦å‘å¹¶é€‰æ‹©è®¾å¤‡ ======
  workflow_dispatch:
    inputs:
      target_device:
        description: 'Select Target Device'
        required: true
        default: 'amlogic_meson8b' # é»˜è®¤è®¾ç½®ä¸º amlogic_meson8bï¼Œæ–¹ä¾¿ä½ 
        type: choice
        options:
          - x86_64
          - amlogic_meson8b # æ·»åŠ è¿™ä¸ªï¼Œå¯¹åº”ä½ çš„ç©å®¢äº‘
          - armsr_armv8 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–AArch64è®¾å¤‡
          - qualcommax_ipq807x # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - mediatek_mt7622 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - mediatek_mt7981 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - mediatek_filogic # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - bcm27xx_bcm2710 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - qualcommax_ipq60xx # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - bcm4908_generic # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - sunxi_cortexa53 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - ramips_mt7621 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - ramips_mt7620 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - ramips_mt76x8 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - ath79_nand # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - ipq40xx_generic # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - bcm27xx_bcm2709 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - sunxi_cortexa7 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - qualcommax_ipq50xx # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - bcm53xx # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - mvebu_cortexa9 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - ipq806x_generic # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - bcm27xx_bcm2708 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - bcm27xx_bcm2711 # æºç ä¸­å­˜åœ¨çš„å…¶ä»–è®¾å¤‡
          - rockchip_rk35xx # æºç ä¸­å­˜åœ¨çš„å…¶ä»–rockchipè®¾å¤‡
  # ===============================================

env:
  # åŸå§‹çš„ env å˜é‡ï¼Œä¿æŒä¸å˜
  REPO_TOKEN: ${{ secrets.TOKEN_KIDDIN9 }}
  PPPOE_USERNAME: ${{ secrets.PPPOE_USERNAME }}
  PPPOE_PASSWD: ${{ secrets.PPPOE_PASSWD }}
  SCKEY: ${{ secrets.SCKEY }}
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  DOCKER_ID: ${{ secrets.DOCKER_ID }}
  DOCKER_PASSWD: ${{ secrets.DOCKER_PASSWD }}
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    
    # ä¿®æ”¹è¿™é‡Œçš„ strategy.matrix.targetï¼Œä½¿å…¶ä» inputs.target_device è·å–å€¼
    name: Build ${{ github.event.inputs.target_device || matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        target: ["${{ github.event.client_payload.target }}"] # ä¿æŒåŸå§‹çš„ repository_dispatch è§¦å‘æ—¶çš„å…¼å®¹
        
    steps:
    - name: Checkout
      uses: actions/checkout@main
      with:
          fetch-depth: 0

    # è¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® TARGET_BOARD å’Œ TARGET_SUBTARGET
    # å› ä¸ºåŸè„šæœ¬çš„ `Load Settings.ini` æ­¥éª¤ä¼šå¤„ç†è¿™äº›ã€‚
    # æˆ‘ä»¬åªéœ€è¦ç¡®ä¿ `matrix.target` ï¼ˆåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œå¯¹åº” `github.event.inputs.target_device`ï¼‰
    # èƒ½æ­£ç¡®ä¼ é€’ç»™ `Load Settings.ini` æ­¥éª¤ã€‚

    - name: Load Settings.ini
      run: |
        # ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨é€‰æ‹©çš„ target_deviceï¼Œå¦‚æœ repository_dispatch è§¦å‘åˆ™ç”¨ matrix.target
        SELECTED_TARGET="${{ github.event.inputs.target_device || matrix.target }}"
        echo "Selected target: $SELECTED_TARGET"
        
        # æ£€æŸ¥ devices/common/settings.ini
        if [ -f "${GITHUB_WORKSPACE}/devices/common/settings.ini" ]; then
          echo "Loading common settings from devices/common/settings.ini"
          source "${GITHUB_WORKSPACE}/devices/common/settings.ini"
        else
          echo "Warning: devices/common/settings.ini not found. Some variables might be unset."
        fi
        
        # æ£€æŸ¥ç‰¹å®šè®¾å¤‡çš„ settings.ini
        if [ -f "${GITHUB_WORKSPACE}/devices/$SELECTED_TARGET/settings.ini" ]; then
          echo "Loading device specific settings from devices/$SELECTED_TARGET/settings.ini"
          source "${GITHUB_WORKSPACE}/devices/$SELECTED_TARGET/settings.ini"
        else
          echo "No device specific settings.ini found for $SELECTED_TARGET."
        fi

        # ç¡®ä¿ REPO_URL å’Œ REPO_BRANCH è¢«æ­£ç¡®è®¾ç½®ï¼Œä»¥é˜² settings.ini ä¸­æ²¡æœ‰
        echo "REPO_URL=${REPO_URL:-https://github.com/openwrt/openwrt.git}" >> $GITHUB_ENV # é»˜è®¤OpenWrtå®˜æ–¹ä»“åº“
        echo "REPO_BRANCH=${REPO_BRANCH:-master}" >> $GITHUB_ENV # é»˜è®¤masteråˆ†æ”¯

        echo "CONFIG_FILE=${CONFIG_FILE:-.config}" >> $GITHUB_ENV # é»˜è®¤ .config
        echo "DIY_SH=${DIY_SH:-diy.sh}" >> $GITHUB_ENV # é»˜è®¤ diy.sh
        echo "FREE_UP_DISK=${FREE_UP_DISK:-false}" >> $GITHUB_ENV
        echo "UPLOAD_BIN_DIR_FOR_ARTIFACT=${UPLOAD_BIN_DIR_FOR_ARTIFACT:-true}" >> $GITHUB_ENV # ç¡®ä¿å›ºä»¶ä¼šè¢«ä¸Šä¼ åˆ° Artifacts
        echo "UPLOAD_FIRMWARE_FOR_ARTIFACT=${UPLOAD_FIRMWARE_FOR_ARTIFACT:-true}" >> $GITHUB_ENV # ç¡®ä¿å›ºä»¶ä¼šè¢«ä¸Šä¼ åˆ° Artifacts
        echo "UPLOAD_FIRMWARE_FOR_RELEASE=${UPLOAD_FIRMWARE_FOR_RELEASE:-false}" >> $GITHUB_ENV
        echo "UPLOAD_FIRMWARE_TO_COWTRANSFER=${UPLOAD_FIRMWARE_TO_COWTRANSFER:-false}" >> $GITHUB_ENV
        echo "UPLOAD_FIRMWARE_TO_WETRANSFER=${UPLOAD_FIRMWARE_TO_WETRANSFER:-false}" >> $GITHUB_ENV

        sed -i "1a REPO_TOKEN=${{ secrets.TOKEN_KIDDIN9 }}" ${GITHUB_WORKSPACE}/devices/common/diy.sh
        # æ³¨æ„ï¼šè¿™é‡Œ original çš„è„šæœ¬ä½¿ç”¨äº† ${{matrix.target}}ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åœ¨æ‰‹åŠ¨è§¦å‘æ—¶å®ƒèƒ½æ‹¿åˆ°æ­£ç¡®çš„å€¼
        # matrix.target åœ¨ workflow_dispatch è§¦å‘æ—¶é»˜è®¤æ˜¯ç©ºçš„ï¼Œæˆ–è€…å–å†³äº client_payload
        # æˆ‘ä»¬éœ€è¦åœ¨ Load Settings.ini é˜¶æ®µå°±è®¾ç½®å¥½ï¼Œæˆ–è€…ç¡®ä¿åç»­æ­¥éª¤ä½¿ç”¨æ­£ç¡®çš„å˜é‡
        # ç»è¿‡åˆ†æï¼Œåé¢çš„è„šæœ¬å¤§éƒ¨åˆ†éƒ½æ˜¯ç”¨çš„ ${{matrix.target}}
        # æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿åœ¨ workflow_dispatch è§¦å‘æ—¶ï¼Œmatrix.target èƒ½å¤Ÿè¢«æ­£ç¡®èµ‹å€¼
        # æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨è¿™ä¸ª load settings çš„ run å—é‡Œï¼Œæ‰‹åŠ¨è®¾ç½® matrix.target çš„è¡Œä¸º
        # ä½†æ˜¯ï¼ŒGitHub Actions çš„ matrix å˜é‡æ˜¯å›ºå®šåœ¨ job å¼€å§‹å‰çš„ï¼Œä¸èƒ½åœ¨ step ä¸­æ›´æ”¹ã€‚
        # è§£å†³åŠæ³•æ˜¯ï¼šè°ƒæ•´ jobs.build.strategy.matrix
        # è€ƒè™‘åˆ° original çš„ matrix ä¾èµ– client_payload.targetï¼Œæˆ‘ä»¬ä¿®æ”¹ strategy è®©ä»–ä» input æˆ– client_payload ä¸­è·å–
        
        # ä¿®æ­£ strategy.matrix.target çš„å®šä¹‰ï¼Œä½¿å…¶åŒæ—¶æ”¯æŒ repository_dispatch å’Œ workflow_dispatch
        # å·²ç»åœ¨ä¸Šé¢çš„ jobs.build.strategy.matrix éƒ¨åˆ†ä¿®æ”¹ï¼Œä½¿å…¶æ ¹æ®è§¦å‘ç±»å‹è·å– targetã€‚
        
        # ç¡®ä¿ diy.sh æ‹¿åˆ°æ­£ç¡®çš„ TARGET
        sed -i "1a TARGET=${SELECTED_TARGET}" ${GITHUB_WORKSPACE}/devices/common/diy.sh
        
        # Original script's ARCH and MTARGET detection
        if [ "$SELECTED_TARGET" == "x86_64" ]; then
            echo "ARCH=linux/amd64" >> $GITHUB_ENV
            echo "MTARGET=x86_64" >> $GITHUB_ENV
        elif [ "$SELECTED_TARGET" == "x86_generic" ]; then
            echo "ARCH=linux/amd32" >> $GITHUB_ENV
            echo "MTARGET=x86_generic" >> $GITHUB_ENV
        elif [[ "$SELECTED_TARGET" =~ (armsr_armv8|qualcommax_ipq807x|mediatek_mt7622|mediatek_mt7981|mediatek_filogic|bcm27xx_bcm2710|qualcommax_ipq60xx|bcm4908_generic|sunxi_cortexa53) ]]; then
            echo "MTARGET=aarch64_cortex-a53" >> $GITHUB_ENV
        elif [[ "$SELECTED_TARGET" =~ (ramips_mt7621|ramips_mt7620|ramips_mt76x8) ]]; then
            echo "MTARGET=mipsel_24kc" >> $GITHUB_ENV
        elif [[ "$SELECTED_TARGET" == "ath79_nand" ]]; then
            echo "MTARGET=mips_24kc" >> $GITHUB_ENV
        elif [[ "$SELECTED_TARGET" =~ (ipq40xx_generic|bcm27xx_bcm2709|sunxi_cortexa7|qualcommax_ipq50xx) ]]; then
            echo "MTARGET=arm_cortex-a7_neon-vfpv4" >> $GITHUB_ENV
        elif [[ "$SELECTED_TARGET" == "amlogic_meson8b" ]]; then
            echo "MTARGET=arm_cortex-a5_vfpv4" >> $GITHUB_ENV # ç©å®¢äº‘çš„MTARGET
        elif [[ "$SELECTED_TARGET" == "bcm53xx" ]]; then
            echo "MTARGET=arm_cortex-a9" >> $GITHUB_ENV
        elif [[ "$SELECTED_TARGET" == "mvebu_cortexa9" ]]; then
            echo "MTARGET=arm_cortex-a9_vfpv3-d16" >> $GITHUB_ENV
        elif [[ "$SELECTED_TARGET" == "ipq806x_generic" ]]; then
            echo "MTARGET=arm_cortex-a15_neon-vfpv4" >> $GITHUB_ENV
        elif [[ "$SELECTED_TARGET" == "bcm27xx_bcm2708" ]]; then
            echo "MTARGET=arm_arm1176jzf-s_vfp" >> $GITHUB_ENV
        else
            echo "ARCH=linux/arm64" >> $GITHUB_ENV
            if [[ "$SELECTED_TARGET" == "bcm27xx_bcm2711" ]]; then
                echo "MTARGET=aarch64_cortex-a72" >> $GITHUB_ENV
            elif [[ "$SELECTED_TARGET" == rockchip* ]]; then
                echo "MTARGET=aarch64_generic" >> $GITHUB_ENV
            fi
        fi

    - name: Get current date
      id: date
      run: |
        echo "date=$(date +'%m/%d_%Y_%H/%M')" >> $GITHUB_ENV
        echo "date2=$(date +'%m/%d %Y')" >> $GITHUB_ENV
        VERSION="$(echo "${{github.event.action}}" | grep -Eo " [0-9.]+" | sed -e 's/ //')" || true
        [ "$VERSION" ] && echo "VERSION=$VERSION" >> $GITHUB_ENV || echo "VERSION=$(date +'%m.%d')" >> $GITHUB_ENV

    - name: Clone source code
      run: |
        set -x
        # ä¿®æ­£ TOKEN_KIDDIN9 çš„ä½¿ç”¨ï¼Œç¡®ä¿ Bearer å‰ç¼€
        TAG_INFO="$(curl -gs -H 'Content-Type: application/json' \
          -H "Authorization: Bearer ${{ secrets.TOKEN_KIDDIN9 }}" \
          -X POST -d '{ "query": "query {repository(owner: \"openwrt\", name: \"openwrt\") {refs(refPrefix: \"refs/tags/\", first: 4, orderBy: {field: TAG_COMMIT_DATE, direction: DESC}) {nodes {name target { ... on Tag {tagger {date}}}}}}}"}' https://api.github.com/graphql)"
        TAG_DATE="$( echo ${TAG_INFO} | jq -r '.data.repository.refs.nodes[] | select(.name | startswith("v24")) | .target.tagger.date' | head -n 1)"
        if [[ $(( ($(date +%s) - $(date -d "$TAG_DATE" +%s)) / 86400 )) -lt 20 ]]; then
        REPO_BRANCH="$( echo ${TAG_INFO} | jq -r '.data.repository.refs.nodes[].name' | grep v24 | head -n 1)"
        #REPO_BRANCH="openwrt-24.10"
        else
        REPO_BRANCH="openwrt-24.10"
        fi
        echo "CONFIG_VERSION_REPO=\"https://dl.openwrt.ai/releases/24.10\"">>devices/common/.config
        if [[ ! "${{ env.REPO_BRANCH }}" && "$REPO_URL" == "https://github.com/openwrt/openwrt" ]]; then
            git clone $REPO_URL -b $REPO_BRANCH openwrt
        elif [[ ! "${{ env.REPO_BRANCH }}" ]]; then
            git clone $REPO_URL openwrt
        else
            REPO_BRANCH="${{env.REPO_BRANCH}}"
            if [[ ${#REPO_BRANCH} -lt 10 ]]; then
                git clone $REPO_URL -b ${REPO_BRANCH} openwrt
            else
                git clone $REPO_URL openwrt
                cd openwrt
                git checkout ${REPO_BRANCH}
            fi
        fi

    - name: Free up disk space
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/staging_dir /mnt/openwrt/build_dir
        ln -sf /mnt/openwrt/dl openwrt/dl
        ln -sf /mnt/openwrt/staging_dir openwrt/staging_dir
        ln -sf /mnt/openwrt/build_dir openwrt/build_dir

    - name: Load custom configuration
      run: |
        function git_clone_path() {
          trap 'rm -rf "$tmpdir"' EXIT
          branch="$1" rurl="$2" mv="$3"
          [[ "$mv" != "mv" ]] && shift 2 || shift 3
          rootdir="$PWD"
          tmpdir="$(mktemp -d)" || exit 1
          if [ ${#branch} -lt 10 ]; then
          git clone -b "$branch" --depth 1 --filter=blob:none --sparse "$rurl" "$tmpdir"
          cd "$tmpdir"
          else
          git clone --filter=blob:none --sparse "$rurl" "$tmpdir"
          cd "$tmpdir"
          git checkout $branch
          fi
          if [ "$?" != 0 ]; then
            echo "error on $rurl"
            exit 1
          fi
          git sparse-checkout init --cone
          git sparse-checkout set $@
          [[ "$mv" != "mv" ]] && cp -rn ./* $rootdir/ || mv -n $@/* $rootdir/$@/
          cd $rootdir
          }
        export -f git_clone_path
        
        # æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ SELECTED_TARGET æ¥åŠ è½½è®¾å¤‡ç‰¹å®šé…ç½®
        SELECTED_TARGET="${{ github.event.inputs.target_device || matrix.target }}"

        # å¤åˆ¶ common ç›®å½•ä¸‹çš„æ–‡ä»¶
        cp -rf devices/common/. openwrt/
        
        # å¤åˆ¶ç‰¹å®šè®¾å¤‡ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œè¦†ç›– common
        if [ -d "devices/$SELECTED_TARGET" ]; then
          echo "Copying device specific files from devices/$SELECTED_TARGET"
          cp -rf "devices/$SELECTED_TARGET/." openwrt/
        else
          echo "Warning: Device directory devices/$SELECTED_TARGET not found. Using common configuration."
        fi
        
        cp -rf devices openwrt/
        cd openwrt
        
        chmod +x devices/common/$DIY_SH
        /bin/bash "devices/common/$DIY_SH"
        
        # å¤åˆ¶ .config æ–‡ä»¶
        cp -f devices/common/$CONFIG_FILE .config
        if [ -f "devices/$SELECTED_TARGET/$CONFIG_FILE" ]; then
          echo >> .config
          cat devices/$SELECTED_TARGET/$CONFIG_FILE >> .config
        fi
        
        # æ‰§è¡Œè®¾å¤‡ç‰¹å®šçš„ DIY è„šæœ¬
        if [ -f "devices/$SELECTED_TARGET/$DIY_SH" ]; then
          chmod +x "devices/$SELECTED_TARGET/$DIY_SH"
          echo "/bin/bash devices/$SELECTED_TARGET/$DIY_SH"
          /bin/bash "devices/$SELECTED_TARGET/$DIY_SH"
        fi
        cp -Rf ./diy/* ./ || true

    - name: Apply patches
      run: |
        cd openwrt
        # ç¡®ä¿ patches è·¯å¾„æ­£ç¡®ï¼Œå¹¶ä½¿ç”¨ SELECTED_TARGET
        SELECTED_TARGET="${{ github.event.inputs.target_device || matrix.target }}"
        
        # æ£€æŸ¥å¹¶å¤åˆ¶ç‰¹å®šè®¾å¤‡çš„è¡¥ä¸åˆ°å…¬å…± patches ç›®å½•ï¼ˆå¦‚æœKwrtè¿™æ ·ç»„ç»‡çš„è¯ï¼‰
        # åŸå§‹è„šæœ¬è¿™è¡Œæ˜¯ `cp -rn devices/common/patches devices/${{matrix.target}}/`
        # çœ‹èµ·æ¥å®ƒæ˜¯æŠŠ common çš„ patch å¤åˆ¶åˆ° target ç›®å½•ï¼Œç„¶åä» target ç›®å½•åº”ç”¨
        # æˆ‘ä»¬ä¿æŒåŸæœ‰çš„é€»è¾‘ï¼Œä½†ç¡®ä¿ä½¿ç”¨ SELECTED_TARGET
        
        # åŸå§‹è„šæœ¬çš„é€»è¾‘ï¼šå°† common/patches å¤åˆ¶åˆ° devices/SELECTED_TARGET/patches (å¦‚æœä¸å­˜åœ¨)
        mkdir -p "devices/$SELECTED_TARGET/patches"
        cp -rn devices/common/patches/* "devices/$SELECTED_TARGET/patches/" || true # ç¡®ä¿å¤åˆ¶
        
        # ç„¶åä» devices/SELECTED_TARGET/patches åº”ç”¨è¡¥ä¸
        if [ -n "$(ls -A devices/$SELECTED_TARGET/patches/*.bin.patch 2>/dev/null)" ]; then
            git apply devices/$SELECTED_TARGET/patches/*.bin.patch
        fi
        find "devices/$SELECTED_TARGET/patches" -maxdepth 1 -type f -name '*.revert.patch' -print0 | sort -z | xargs -I % -t -0 -n 1 sh -c "cat '%' | patch -d './' -R -B --merge -p1 --forward"
        find "devices/$SELECTED_TARGET/patches" -maxdepth 1 -type f -name '*.patch' ! -name '*.revert.patch' ! -name '*.bin.patch' -print0 | sort -z | xargs -I % -t -0 -n 1 sh -c "cat '%' | patch -d './' -B --merge -p1 --forward"
        
        sed -i '$a \
        CONFIG_CPU_FREQ_GOV_POWERSAVE=y \
        CONFIG_CPU_FREQ_GOV_USERSPACE=y \
        CONFIG_CPU_FREQ_GOV_ONDEMAND=y \
        CONFIG_CPU_FREQ_GOV_CONSERVATIVE=y \
        CONFIG_CRYPTO_CHACHA20_NEON=y \
        CONFIG_CRYPTO_CHACHA20POLY1305=y \
        CONFIG_FAT_DEFAULT_IOCHARSET="utf8" \
        ' `find target/linux -path "target/linux/*/config-*"`

    - name: Defconfig
      run: |
        cd openwrt
        make defconfig
        
        # ä½¿ç”¨ SELECTED_TARGET å˜é‡
        SELECTED_TARGET="${{ github.event.inputs.target_device || matrix.target }}"

        if [[ ! "$SELECTED_TARGET" =~ (amlogic_*|armsr_armv8|bcm27xx_*|rockchip_armv8|sunxi_*|x86_*) ]]; then
        sed -n '/# Wireless Drivers/,/# end of Wireless Drivers/p' .config | sed -e 's/=m/=n/' >>.config
        if [[ "$SELECTED_TARGET" == "rockchip_rk35xx" ]]; then 
            sed -n '/# Video Support/,/# end of Video Support/p' .config | sed -e 's/=m/=n/' >>.config
        fi
        make defconfig
        fi
        cat .config

    - name: Cache
      uses: stupidloud/cachewrtbuild@main
      with:
        ccache: 'true'
        mixkey: ${{ github.event.inputs.target_device || matrix.target }} # ä¿®æ­£ mixkey
        clean: ${{ contains(github.event.action, 'nocache') }}
        prefix: ${{ github.workspace }}/openwrt
    
    - name: Check space usage
      run: |
        shopt -s extglob
        cd openwrt
        # ç¡®ä¿ env.MTARGET è¢«æ­£ç¡®è®¾ç½®
        if [[ -f staging_dir/*${{ env.MTARGET }}*/bin ]]; then
            rm -rf staging_dir/!(*${{ env.MTARGET }}*|host|hostpkg) build_dir/!(*${{ env.MTARGET }}*|host|hostpkg)
        fi
        df -hT

    - name: SSH connection to Actions
      uses: kiddin9/debugger-action@master
      if: contains(github.event.action, 'ssh')

    - name: Compile the firmware
      id: compile
      run: |
        shopt -s extglob
        cd openwrt
        echo -e "$(($(nproc)+1)) thread compile"
        make -j$(($(nproc)+1)) || make V=s &>build.log || (tail -50 build.log; curl -k --data chat_id="${{ env.TELEGRAM_CHAT_ID }}" --data "text=âŒ OpenWrt ${{ env.VERSION }} ${{ github.event.inputs.target_device || matrix.target }} ç¼–è¯‘å¤±è´¥ ğŸ˜‚" "https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage";df -hT;exit 1) # ä¿®æ­£è¿™é‡Œçš„ target ä¿¡æ¯
        sed -i "s/# CONFIG_IB is not set/CONFIG_IB=y/" .config
        rm -rf staging_dir/toolchain-*/bin/*openwrt-linux-musl-lto-dump
        rm -rf staging_dir/toolchain-*/initial
        df -hT

    - name: Organize files
      id: organize
      continue-on-error: true
      run: |
        shopt -s extglob
        cd openwrt/bin/targets/*/*/
        cp $GITHUB_WORKSPACE/openwrt/.config ${{ github.event.inputs.target_device || matrix.target }}.config || true # ä¿®æ­£è¿™é‡Œçš„ target ä¿¡æ¯
        cp $GITHUB_WORKSPACE/openwrt/build_dir/target-*/linux-*/linux-*/.config ${{ github.event.inputs.target_device || matrix.target }}_kernel.config || true # ä¿®æ­£è¿™é‡Œçš„ target ä¿¡æ¯
        rm -rf kwrt-!(*imagebuilder*)
        Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
        echo "EMOJI=${Emoji[$[$RANDOM % ${#Emoji[@]}]]}" >> $GITHUB_ENV

    - name: Upload firmware for artifact
      uses: actions/upload-artifact@main
      if: env.UPLOAD_FIRMWARE_FOR_ARTIFACT == 'true'
      with:
        name: ${{ env.VERSION }}_${{ github.event.inputs.target_device || matrix.target }} # ä¿®æ­£ artifact name
        path: |
          openwrt/bin/targets/

    - name: Deploy imagebuilder to server
      uses: easingthemes/ssh-deploy@main
      if: env.SSH_PRIVATE_KEY && ! contains(github.event.action, 'noser')
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        ARGS: "-avzr"
        SOURCE: openwrt/bin/targets
        REMOTE_HOST: ${{ secrets.SERVER_HOST }}
        REMOTE_PORT: ${{ secrets.SERVER_PORT }}
        REMOTE_USER: root
        TARGET: "/www/wwwroot/dl.openwrt.ai/releases/tmp/"

    - name: Create release
      id: create_release
      if: env.REPO_TOKEN && env.UPLOAD_FIRMWARE_FOR_RELEASE == 'true'
      continue-on-error: true
      run: |
        echo -e "å¢™å†…åŠ é€Ÿä¸‹è½½ ğŸš€:\n" >> release.txt
        echo -e "[è…¾è®¯äº‘] (https://dl.openwrt.ai/firmware/${{ github.event.inputs.target_device || matrix.target }}/ â˜)\n" >> release.txt # ä¿®æ­£è¿™é‡Œçš„ target ä¿¡æ¯
        [ ${{ env.WETRANS }} ] && echo -e "[WeTransfer] (${{ env.WETRANS }} ğŸ—½)\n" >> release.txt
        [ ${{ env.COWURL }} ] && echo -e "[å¥¶ç‰›ä¸Šä¼ ] (${{ env.COWURL }} ğŸ®)\n" >> release.txt
        [ ${{ env.NOTICE }} ] && echo -e "${{ env.NOTICE }}" >> release.txt || true

    - name: Upload firmware for release
      uses: softprops/action-gh-release@master
      continue-on-error: true
      if: env.REPO_TOKEN && env.UPLOAD_FIRMWARE_FOR_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_KIDDIN9 }}
      with:
        files: "${{ env.FIRMWARE }}/*"
        name: ${{ env.date2 }} ${{ github.event.inputs.target_device || matrix.target }} ${{ env.EMOJI }} # ä¿®æ­£è¿™é‡Œçš„ target ä¿¡æ¯
        tag_name: ${{ env.date }}_${{ github.event.inputs.target_device || matrix.target }} # ä¿®æ­£è¿™é‡Œçš„ target ä¿¡æ¯
        body_path: release.txt
    
    - name: WeChat notification
      continue-on-error: true
      if: env.SCKEY
      run: |
        # [ steps.compile.outputs.status == 'success' ] && curl https://sctapi.ftqq.com/${{ secrets.SCKEY }}.send?text=ğŸ‰OpenWrt_${{ env.VERSION }}_${{ github.event.inputs.target_device || matrix.target }}ç¼–è¯‘å®ŒæˆğŸ˜‹|| curl https://sctapi.ftqq.com/${{ secrets.SCKEY }}.send?text=âŒOpenWrt_${{ env.VERSION }}_${{ github.event.inputs.target_device || matrix.target }}ç¼–è¯‘å¤±è´¥ğŸ˜‚ # ä¿®æ­£è¿™é‡Œçš„ target ä¿¡æ¯

    - name: Telegram notification
      if: env.TELEGRAM_TOKEN && ! contains(github.event.action, 'notg')
      continue-on-error: true
      run: |
        curl -k --data chat_id="${{ env.TELEGRAM_CHAT_ID }}" --data "text=ğŸ‰ OpenWrt ${{ env.VERSION }} ${{ github.event.inputs.target_device || matrix.target }} ç¼–è¯‘æˆåŠŸ ğŸ˜‹  https://dl.openwrt.ai/firmware/${{ github.event.inputs.target_device || matrix.target }}/  ${{ env.COWURL }}    ${{ env.WETRANS }} ğŸš€" "https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage" # ä¿®æ­£è¿™é‡Œçš„ target ä¿¡æ¯

    - name: Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      continue-on-error: true
      with:
        token: ${{ secrets.TOKEN_KIDDIN9 }}
        retain_days: 100
        keep_minimum_runs: 0

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@master
      continue-on-error: true
      if: env.UPLOAD_FIRMWARE_FOR_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 15
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_KIDDIN9 }}
